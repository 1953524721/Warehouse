<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户页面</title>
    <style>
        /* 现有的样式 */
        table tr:nth-child(odd) {
            background-color: #f2f2f2; /* 奇数行的背景颜色 */
        }

        table tr:nth-child(even) {
            background-color: #ffffff; /* 偶数行的背景颜色 */
        }

        /* 固定表头 */
        th {
            position: sticky;
            top: 0;
            background-color: #7EB6FD; /* 表头背景颜色 */
            color: white; /* 表头文字颜色 */
            z-index: 1; /* 确保表头在其他内容之上 */
        }
        .page ul {
            list-style-type: none; /* 去掉默认的列表样式 */
            padding: 0; /* 去掉默认的内边距 */
            margin: 0; /* 去掉默认的外边距 */
        }

        .page li {
            display: inline-block; /* 水平排列 */
            margin-right: 10px; /* 右侧间距 */
        }
        td{
            width: 200px;
        }

        /* 模态对话框样式 */
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定定位 */
            z-index: 1; /* 放在最上层 */
            left: 0;
            top: 0;
            width: 100%; /* 宽度为100% */
            height: 100%; /* 高度为100% */
            overflow: auto; /* 溢出部分滚动 */
            background-color: rgb(0,0,0); /* 背景颜色 */
            background-color: rgba(0,0,0,0.4); /* 半透明背景 */
            padding-top: 60px; /* 顶部内边距 */
        }

        .modal-content {
            background-color: #fefefe; /* 内容背景颜色 */
            margin: 5% auto; /* 上下居中 */
            padding: 20px; /* 内边距 */
            border: 1px solid #888; /* 边框 */
            width: 80%; /* 宽度 */
        }

        .close {
            color: #aaa; /* 关闭按钮颜色 */
            float: right; /* 右对齐 */
            font-size: 28px; /* 字体大小 */
            font-weight: bold; /* 加粗 */
        }

        .close:hover,
        .close:focus {
            color: black; /* 鼠标悬停时的颜色 */
            text-decoration: none; /* 去掉下划线 */
            cursor: pointer; /* 鼠标指针样式 */
        }
        .state-normal {
            color: green;
        }

        /* 定义状态异常的样式 */
        .state-abnormal {
            color: red;
        }
    </style>
</head>
<body>
<div id="app">
    <table>
        <tr>
            <th>ID</th>
            <th>名字</th>
            <th>状态</th>
            <th>操作</th>
        </tr>

        <tbody id="data-table">
        <!-- 数据将在这里动态插入 -->
        </tbody>

        <tr>
            <td colspan="3" class="page">
                <input type="button" value="首页" class="one">
                <input type="button" value="上一页" class="up">
                <input type="button" value="下一页" class="down">
                <input type="button" value="尾页" class="last">
            </td>
            <td>
                <span class="span"></span>
            </td>
        </tr>
    </table>
</div>

<!-- 模态对话框 -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <form id="productForm" method="post" enctype="multipart/form-data">
            <input type="hidden" id="id" name="id" value="">

            <label for="names">名字:</label>
            <input type="text" id="names" name="names" value=""><br>

            <input type="button" value="提交" class="submit">
            <span class="error-message"></span>
        </form>
    </div>
</div>

<script src="/{$appName}/public/static/jquery-3.7.1.js"></script>
<script type="text/javascript">
    $.ajaxSetup({
        beforeSend: function(xhr) {
            // 获取CSRF令牌
            const csrfToken = $('meta[name="csrf-token"]').attr('content');
            // 如果CSRF令牌存在，则将其添加到请求头中
            if (csrfToken) {
                xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            }
        }
    });

    // 缓存常用的选择器
    // const $myModal = $('#myModal');
    // const $errorMessage = $('.error-message');
    // const $spanMessage = $('.span');

    $(document).ready(function() {
        let currentPage = 1;
        const pageSize = 10; // 每页显示的记录数
        let totalPages = 1; // 总页数

        function fetchData(page) {
            $.ajax({
                url: '/{$appName}/public/index.php/admin/User/userPageAll', // 替换为你的API端点
                method: 'GET',
                data: {
                    page: page,
                    pageSize: pageSize
                },
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response);
                    // 清空当前表格内容
                    $('#data-table').empty();

                    // 遍历数据并生成表格行
                    response.data.forEach(function(item) {
                        console.log('Item ID:', item.id, typeof item.id); // 调试信息
                        const stateText = item.state === 1 ? '正常' : '异常';
                        const stateClass = item.state === 1 ? 'state-normal' : 'state-abnormal';
                        $('#data-table').append(`
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td class="state-cell ${stateClass}" data-id="${item.id}">${stateText}</td>
                                <td>
                                    <input type="button" value="修改" class="edit-btn" data-id="${item.id}">
                                    <input type="button" value="删除" class="delete-btn" data-id="${item.id}">
                                    <input type="button" value="重置密码" class="uppwd-btn" data-id="${item.id}">
                                </td>
                            </tr>
                        `);
                    });

                    // 更新总页数
                    totalPages = Math.ceil(response.total / pageSize);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        }

        // 初始化加载第一页数据
        fetchData(currentPage);

        // 绑定分页按钮事件
        $('.one').click(function() {
            currentPage = 1;
            fetchData(currentPage);
        });

        $('.up').click(function() {
            if (currentPage > 1) {
                currentPage--;
                fetchData(currentPage);
            }
        });

        $('.down').click(function() {
            if (currentPage < totalPages) {
                currentPage++;
                fetchData(currentPage);
            }
        });

        $('.last').click(function() {
            currentPage = totalPages;
            fetchData(currentPage);
        });

        // 绑定修改按钮事件
        $(document).on('click', '.edit-btn', function() {
            const id = $(this).data('id'); // 获取按钮上的ID
            console.log('Editing item with ID:', id, typeof id); // 调试信息

            // 显示模态对话框
            $myModal.show();

            // 获取数据并填充到表单中
            $.ajax({
                url: '/{$appName}/public/index.php/admin/User/getItem', // 替换为你的API端点
                method: 'GET',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response);
                    $('#id').val(response.id);
                    $('#names').val(response.name);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        });

        // 绑定关闭按钮事件
        $('.close').click(function() {
            $myModal.hide();
        });

        // 绑定表单提交事件
        $('.submit').click(function () {
            console.log('Submit button clicked');
            // 创建 FormData 对象
            const formData = new FormData($('#productForm')[0]);
            // 发起 AJAX 请求
            $.ajax({
                url: '/{$appName}/public/index.php/admin/User/updateItem',  // 你的后端接口地址
                data: formData,
                type: 'post',
                processData: false,  // 不处理数据
                contentType: false,  // 不设置内容类型
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    // 根据响应结果进行处理
                    if (res.status === 'success') {
                        // 操作成功，弹出提示信息并跳转到新页面
                        $errorMessage.text(res.message);
                        // 等待3秒后关闭模态对话框并刷新当前页面数据
                        setTimeout(function() {
                            $myModal.hide(); // 关闭模态对话框
                            fetchData(currentPage); // 刷新当前页面数据
                        }, 3000); // 3000毫秒 = 3秒

                    } else {
                        // 操作失败，显示错误提示
                        $errorMessage.text(res.message);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // 请求失败，输出错误信息并弹出提示信息
                    console.error('AJAX Error: ' + textStatus + ' - ' + errorThrown);
                    alert('请求失败，请稍后再试。');
                }
            });
        });

        // 删除
        $(document).on('click', '.delete-btn', function() {
            const id = $(this).data('id'); // 获取按钮上的ID
            console.log('Deleting item with ID:', id, typeof id); // 调试信息

            if (confirm('确定要删除该项吗？')) {
                // 发送删除请求
                $.ajax({
                    url: '/{$appName}/public/index.php/admin/User/deleteUser', // 替换为你的API端点
                    method: 'POST',
                    data: {
                        id: id
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Item deleted successfully:', response);
                        if (response.status === 'success') {
                            // 删除成功，弹出提示信息并刷新当前页面数据
                            $spanMessage.text(response.message);
                            setTimeout(function() {
                                fetchData(currentPage); // 刷新当前页面数据
                            }, 3000); // 3000毫秒 = 3秒
                        } else {
                            // 删除失败，显示错误提示
                            $spanMessage.text(response.message);
                        }
                        $(`.delete-btn[data-id="${id}"]`).closest('tr').remove();
                        fetchData(currentPage); // 刷新当前页面数据
                    },
                    error: function (xhr, status, error) {
                        $spanMessage.text(response.message);
                        console.error('Error deleting item:', error);
                    }
                });
            } else {
                // 用户点击了“取消”
                console.log('Deletion cancelled by user');
            }
        });

        // 修改密码
        $(document).on('click', '.uppwd-btn', function() {
            const id = $(this).data('id'); // 获取按钮上的ID
            console.log('Editing item with ID:', id, typeof id); // 调试信息
            // 获取数据并填充到表单中
            $.ajax({
                url: '/{$appName}/public/index.php/admin/User/upUserPwd', // 替换为你的API端点
                method: 'GET',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function(response) {
                    console.log('Item updated successfully:', response);
                    $spanMessage.text(response.message);
                    fetchData(currentPage); // 刷新当前页面数据
                },
                error: function(xhr, status, error) {
                    $spanMessage.text('修改失败，请稍后再试。');
                    console.error('Error updating item:', error);
                }
            });
        });

        // 绑定状态单元格点击事件
        $(document).on('click', '.state-cell', function() {
            const id = $(this).data('id'); // 获取按钮上的ID
            const currentState = $(this).hasClass('state-normal') ? 1 : 0; // 获取当前状态
            const newState = currentState === 1 ? 0 : 1; // 切换状态

            console.log('Changing state for item with ID:', id, 'from', currentState, 'to', newState);

            // 发送 AJAX 请求更新状态
            $.ajax({
                url: '/{$appName}/public/index.php/admin/User/updateState', // 替换为你的API端点
                method: 'POST',
                data: {
                    id: id,
                    state: newState
                },
                dataType: 'json',
                success: function(response) {
                    console.log('State updated successfully:', response);
                    if (response.status === 'success') {
                        // 更新前端显示
                        const $cell = $(`.state-cell[data-id="${id}"]`);
                        $cell.toggleClass('state-normal state-abnormal');
                        $cell.text(newState === 1 ? '正常' : '异常');
                    } else {
                        // 操作失败，显示错误提示
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating state:', error);
                    alert('更新状态失败，请稍后再试。');
                }
            });
        });
    });
</script>
</body>
</html>
